#!/bin/bash
[[ -z "$DOTFILES" ]] && \
    DOTFILES="$(dirname "$(readlink -f "$0")")" && \
    source "$DOTFILES/powertools/bash/profile"

make_symlink(){
    if [ -h "$2" ] && ! [ -e "$2" ]
        then
            echo -e "\033[31mRemoving broken link: $(basename "$2")\033[0m"
            rm "$2"
        fi
    if [ ! -h "$2" ]; then
        echo -en "\033[35mLinking\033[33m "
        ln -fvsn "$1" "$2" | sed "s|$HOME|~|g;s|'||g"
        echo -en "\033[0m"
    fi
}

make_makefile(){
    make --directory="$1" | grep -q "is up to date" \
        && return

    OUT_INSTALL="$(make install --directory="$1" | grep -v "directory")"

    echo -e "\033[35mMake install:\033[33m $OUT_INSTALL \033[0m"
}

deploy_dotfiles(){
    while IFS= read -r l; do
        orig="$DOTFILES/powertools/$(echo "$l" | cut -d, -f1)"
        dest=$(echo "$l" | cut -d, -f2 | sed "s|~|$HOME|g")
        mkdir -p "$(dirname "$dest")"

        IFS=',' read -ra VALUES <<< "$l"
        ARGS=("${VALUES[@]:2}")

        if [ -n "$FILTERS" ]; then
            if [ -z "$(comm -12 <(printf '%s\n' "${FILTERS[@]}" | sort) <(printf '%s\n' "${VALUES[@]}" | sort))" ]
            then
                continue
            fi
        fi

        for ARG in "${ARGS[@]}"; do
            case "$ARG" in
                link)
                    make_symlink "$orig" "$dest"
                    ;;
            
                make)
                    make_makefile "$orig" "$dest"
                    ;;

                generated)
                    echo -en "\033[35mGenerating\033[33m "
                    python "$DOTFILES"/generate_config.py "$orig" "$dest"
                    echo -en "\033[0m"
                    ;;
                *)
                    ;;
            esac
        done

    done < <(perl -pe 's/\$(\w+)/$ENV{$1}/g' "$DOTFILES/$1" | sed -e "s|$HOME|~|g")
}

git -C "$DOTFILES" pull

touch "$DOTFILES/.instalation_config"
IFS=$'\n' read -d '' -r -a FILTERS < "$DOTFILES/.instalation_config"

while (( "$#" )); do
    case $1 in
        --*)
            FILTERS+=("${1:2}")
            shift
            ;;
        *)
            shift
            ;;
    esac
done

printf "%s\n" "${FILTERS[@]}" > "$DOTFILES/.instalation_config"

deploy_dotfiles "powertools/.locations"
