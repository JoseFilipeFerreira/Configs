#!/bin/bash
[[ -z "$DOTFILES" ]] && \
    source "$(dirname "$(readlink -f "$0")")powertools/zsh/zprofile"

make_symlink(){
    if [ -h "$2" ] && ! [ -e "$2" ]
        then
            echo -e "\033[31mRemoving broken link: $(basename "$2")\033[0m"
            rm "$2"
        fi
    if [ ! -h "$2" ]; then
        echo -en "\033[35mLinking\033[33m "
        ln -fvsn "$1" "$2" | sed "s|$HOME|~|g;s|'||g"
        echo -en "\033[0m"
    fi
}

make_makefile(){
    make --directory="$1" | grep -q "is up to date" \
        && exit

    OUT_INSTALL="$(make install --directory="$1" | grep -v "directory")"

    echo -e "\033[35mMake install:\033[33m $OUT_INSTALL \033[0m"
}

deploy_dotfiles(){
    while IFS= read -r l; do
        orig="$DOTFILES/powertools/$(echo "$l" | cut -d, -f1)"
        dest=$(echo "$l" | cut -d, -f2 | sed "s|~|$HOME|g")
        mkdir -p "$(dirname "$dest")"

        IFS=',' read -ra VALUES <<< "$l"
        ARGS=("${VALUES[@]:2}")

        for ARG in "${ARGS[@]}"; do
            case "$ARG" in
                link)
                    make_symlink "$orig" "$dest"
                    ;;
            
                make)
                    make_makefile "$orig" "$dest"
                    ;;

                generated)
                    echo -en "\033[35mGenerating\033[33m "
                    python "$DOTFILES"/generate_config.py "$orig" "$dest"
                    echo -en "\033[0m"
                    ;;
                *)
                    echo -e "\033[31mARGS not recognized: $ARG"
                    ;;
            esac
        done

    done < <(perl -pe 's/\$(\w+)/$ENV{$1}/g' "$DOTFILES/$1" | sed -e "s|$HOME|~|g")
}

git -C "$DOTFILES" pull

deploy_dotfiles "powertools/.locations"

case "$1" in
    --no-storeTools)
        ;;
    *)
        sh "$DOTFILES"/storeTools
        ;;
esac
